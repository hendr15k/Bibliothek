<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bibliothek App</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- Lucide Icons (Standalone) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Font -->
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-slate-50 dark:bg-slate-900 transition-colors duration-300">
    <div id="root"></div>

    <script>
        // Setup placeholders if missing
        if (typeof window.__firebase_config === 'undefined') {
            console.warn("Firebase config missing. Using mock config.");
            window.__firebase_config = JSON.stringify({
                apiKey: "mock-api-key",
                authDomain: "mock.firebaseapp.com",
                projectId: "mock-project",
                storageBucket: "mock.appspot.com",
                messagingSenderId: "000000000000",
                appId: "1:000000000000:web:0000000000000000000000"
            });
        }
        if (typeof window.__app_id === 'undefined') {
            window.__app_id = 'default-app-id';
        }
    </script>

    <!-- Import Map for Module Resolution -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"
      }
    }
    </script>

    <!-- App Code Inline to avoid CORS/JSX module issues without build -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Search, Settings, Book, Heart, X, BookOpen, Calendar, User, Info, Library, Loader2, Sparkles, Lightbulb, Tag, CheckCircle, Download, Upload, Filter, Trash2, Rocket, BrainCircuit, ArrowDownCircle, Star, BarChart3, Moon, Sun, Edit3, Save, Layers, Palette, ImagePlus, FileText, ClipboardPaste, AlertTriangle, Trophy, Share2, Shuffle, Flame, RefreshCw, Wand2, SortAsc, Quote, Clock, Play, Pause, Award, PieChart } from 'lucide-react';
        import { initializeApp } from "firebase/app";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "firebase/auth";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, updateDoc, writeBatch, query as firestoreQuery, getDoc } from "firebase/firestore";

        // --- FIREBASE SETUP ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- API KONFIGURATION ---
        const apiKey = "";
        const MODEL_NAME_TEXT = "gemini-2.5-flash-preview-09-2025";
        const MODEL_NAME_IMAGE = "imagen-4.0-generate-001";
        const MODEL_NAME_EDIT = "gemini-2.5-flash-image-preview";

        const CATEGORIES = [
          "Sci-Fi", "Fantasy", "Romane", "Science Fiction", "Krimi", "Thriller",
          "Geschichte", "Biografie", "Sachbuch", "Kinderb√ºcher", "Psychologie"
        ];

        const parseAIResponse = (text) => {
          try {
            const clean = text.replace(/```json/g, '').replace(/```/g, '').trim();
            return JSON.parse(clean);
          } catch (e) {
            console.error("JSON Parse Error", e);
            return [];
          }
        };

        // --- SMART IMAGE COMPRESSION ---
        const compressSmart = async (base64Str) => {
          const MAX_SIZE = 800000;
          const attemptCompress = (src, width, quality) => {
            return new Promise((resolve) => {
              const img = new Image();
              img.src = src;
              img.onload = () => {
                const canvas = document.createElement('canvas');
                let h = img.height * (width / img.width);
                canvas.width = width;
                canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, h);
                resolve(canvas.toDataURL('image/jpeg', quality));
              };
              img.onerror = () => resolve(null);
            });
          };
          const levels = [[600, 0.85], [500, 0.80], [400, 0.70], [300, 0.60], [200, 0.50]];
          for (let [w, q] of levels) {
            const result = await attemptCompress(base64Str, w, q);
            if (result && result.length < MAX_SIZE * 1.37) return result;
          }
          return null;
        };

        const urlToBase64 = async (url) => {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (e) { return null; }
        };

        export default function App() {
          const [user, setUser] = useState(null);
          const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
          const [showSettings, setShowSettings] = useState(false);

          // App States
          const [query, setQuery] = useState('');
          const [books, setBooks] = useState([]);
          const [myLibrary, setMyLibrary] = useState([]);
          const [loading, setLoading] = useState(false);
          const [loadingMore, setLoadingMore] = useState(false);
          const [loadingText, setLoadingText] = useState('');
          const [selectedBook, setSelectedBook] = useState(null);
          const [activeTab, setActiveTab] = useState('search');
          const [error, setError] = useState(null);
          const [libraryFilter, setLibraryFilter] = useState('all');
          const [sortOption, setSortOption] = useState('dateDesc');
          const [aiSearchMode, setAiSearchMode] = useState(false);
          const [showStats, setShowStats] = useState(false);
          const [darkMode, setDarkMode] = useState(false);
          const [readingGoal, setReadingGoal] = useState(12);
          const [librarySearch, setLibrarySearch] = useState('');
          const [recentSearches, setRecentSearches] = useState(() => {
            try {
              const stored = JSON.parse(localStorage.getItem('recentSearches') || '[]');
              return Array.isArray(stored) ? stored : [];
            } catch (e) {
              return [];
            }
          });

          // Stats & Streak
          const [streak, setStreak] = useState(0);
          const [totalMinutesRead, setTotalMinutesRead] = useState(0);
          const [isTimerRunning, setIsTimerRunning] = useState(false);

          // UI States
          const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
          const [showPasteModal, setShowPasteModal] = useState(false);
          const [pasteText, setPasteText] = useState('');
          const [confirmModal, setConfirmModal] = useState({ show: false, title: '', message: '', onConfirm: null, isDestructive: false });

          // Recommendations
          const [recommendations, setRecommendations] = useState([]);
          const [loadingRecs, setLoadingRecs] = useState(false);
          const [loadingMoreRecs, setLoadingMoreRecs] = useState(false);
          const [recSource, setRecSource] = useState('all');

          const fileInputRef = useRef(null);
          const timerRef = useRef(null);

          // --- INITIALISIERUNG & AUTH ---
          useEffect(() => {
            const initAuth = async () => {
              try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                  await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                  await signInAnonymously(auth);
                }
              } catch (error) { console.error("Auth Failed", error); }
            };
            initAuth();
            const unsubscribe = onAuthStateChanged(auth, setUser);
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) setDarkMode(true);
            const savedGoal = localStorage.getItem('readingGoal');
            if (savedGoal) setReadingGoal(parseInt(savedGoal));
            return () => unsubscribe();
          }, []);

          // --- FIRESTORE SYNC ---
          useEffect(() => {
            if (!user) return;
            const booksCollection = collection(db, 'artifacts', appId, 'users', user.uid, 'books');
            const q = firestoreQuery(booksCollection);
            const unsubscribeBooks = onSnapshot(q, (snapshot) => {
              const loadedBooks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setMyLibrary(loadedBooks);
            });

            const updateStats = async () => {
                const statsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'stats', 'summary');
                try {
                    const docSnap = await getDoc(statsRef);
                    const today = new Date().toDateString();
                    let currentStreak = 0;
                    let lastVisit = null;
                    let minutes = 0;

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        currentStreak = data.streak || 0;
                        lastVisit = data.lastVisit;
                        minutes = data.totalMinutesRead || 0;
                    }

                    if (lastVisit !== today) {
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        if (lastVisit === yesterday.toDateString()) currentStreak += 1;
                        else currentStreak = 1;
                        await setDoc(statsRef, { streak: currentStreak, lastVisit: today }, { merge: true });
                    }
                    setStreak(currentStreak);
                    setTotalMinutesRead(minutes);
                } catch (e) { console.error("Stats Error", e); }
            };
            updateStats();
            return () => unsubscribeBooks();
          }, [user]);

          useEffect(() => {
              if (isTimerRunning) {
                  timerRef.current = setInterval(() => {
                      setTotalMinutesRead(prev => prev + (1/60));
                  }, 1000);
              } else {
                  clearInterval(timerRef.current);
                  if (user && totalMinutesRead > 0) {
                      const statsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'stats', 'summary');
                      setDoc(statsRef, { totalMinutesRead: Math.floor(totalMinutesRead) }, { merge: true });
                  }
              }
              return () => clearInterval(timerRef.current);
          }, [isTimerRunning, user]);

          useEffect(() => {
            if (darkMode) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
          }, [darkMode]);

          useEffect(() => { localStorage.setItem('readingGoal', readingGoal.toString()); }, [readingGoal]);
          useEffect(() => { localStorage.setItem('recentSearches', JSON.stringify(recentSearches)); }, [recentSearches]);

          // --- ACTIONS ---
          const showToastMessage = (message, type = 'success') => {
            setToast({ show: true, message, type });
            setTimeout(() => setToast({ ...toast, show: false }), 3000);
          };

          const addReadingMinutes = (minutes) => {
            if (!minutes || minutes <= 0) return;
            setTotalMinutesRead(prev => {
              const updated = prev + minutes;
              if (user) {
                const statsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'stats', 'summary');
                setDoc(statsRef, { totalMinutesRead: Math.floor(updated) }, { merge: true });
              }
              return updated;
            });
            showToastMessage(`+${minutes} Minuten gespeichert`, "info");
          };

          const openConfirm = (title, message, onConfirm, isDestructive = false) => {
            setConfirmModal({ show: true, title, message, onConfirm, isDestructive });
          };
          const closeConfirm = () => setConfirmModal({ ...confirmModal, show: false });

          const updateRecentSearches = (term) => {
            if (!term) return;
            setRecentSearches((prev) => {
              const normalized = term.trim();
              if (!normalized) return prev;
              const next = [normalized, ...prev.filter((item) => item.toLowerCase() !== normalized.toLowerCase())];
              return next.slice(0, 6);
            });
          };

          const pickRandomBook = () => {
              const unread = myLibrary.filter(b => !b.isRead);
              if (unread.length === 0) { showToastMessage("Alles gelesen! Wow!", "info"); return; }
              const randomBook = unread[Math.floor(Math.random() * unread.length)];
              setSelectedBook(randomBook);
              showToastMessage("Zufallsbuch ausgew√§hlt! üé≤");
          };

          const updateBookData = async (bookId, changes) => {
            setBooks(prev => prev.map(b => b.id === bookId ? { ...b, ...changes } : b));
            if (selectedBook && selectedBook.id === bookId) setSelectedBook(prev => ({ ...prev, ...changes }));
            const inLib = myLibrary.find(b => b.id === bookId);
            if (inLib && user) {
              try { await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'books', bookId), changes); }
              catch (err) { if (err.message && err.message.includes("longer than")) showToastMessage("Bild zu gro√ü!", "error"); }
            }
          };

          const addToLibrary = async (book) => {
            if (!user) return;
            try {
              const bookRef = doc(db, 'artifacts', appId, 'users', user.uid, 'books', book.id);
              const newBookData = { ...book, isRead: false, rating: 0, userNote: '', addedAt: new Date().toISOString() };
              const size = new Blob([JSON.stringify(newBookData)]).size;
              if (size > 1000000) { delete newBookData.aiCoverUrl; showToastMessage("Gespeichert (ohne Bild)", "info"); }
              else { showToastMessage("Buch gespeichert!"); }
              await setDoc(bookRef, newBookData);
            } catch (err) { showToastMessage("Fehler beim Speichern", "error"); }
          };

          const removeFromLibrary = async (bookId) => {
            if (!user) return;
            try { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'books', bookId)); showToastMessage("Buch entfernt", "info"); } catch (err) { console.error(err); }
          };

          const toggleReadStatus = async (book) => {
            const existing = myLibrary.find(b => b.id === book.id);
            if (existing) {
              const newStatus = !existing.isRead;
              await updateBookData(book.id, { isRead: newStatus });
              showToastMessage(newStatus ? "Gelesen! üéâ" : "Als ungelesen markiert");
            } else {
              if (!user) return;
              const newBook = { ...book, isRead: true, rating: 0, userNote: '', addedAt: new Date().toISOString() };
              await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'books', book.id), newBook);
              showToastMessage("Gespeichert & Gelesen! üéâ");
              setBooks(prev => prev.map(b => b.id === book.id ? { ...b, isRead: true } : b));
            }
          };

          // --- SEARCH & AI ---
          const fetchDetailsForList = async (list) => {
            const results = await Promise.all(list.map(async (s) => {
              try {
                const q = s.author ? `intitle:${s.title} inauthor:${s.author}` : `intitle:${s.title}`;
                const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}&maxResults=1`);
                const data = await res.json();
                return data.items?.[0];
              } catch (e) { return null; }
            }));
            return results.filter(b => b);
          };

          const searchBooks = async (e, overrideQuery = null) => {
            if (e) e.preventDefault();
            const searchTerm = overrideQuery || query;
            if (!searchTerm.trim()) return;
            if (overrideQuery) setQuery(overrideQuery);
            updateRecentSearches(searchTerm);
            setLoading(true); setBooks([]);
            try {
              if (aiSearchMode) {
                if (!apiKey) { showToastMessage("API Key fehlt!", "error"); setLoading(false); return; }
                setLoadingText('KI kuratiert...');
                const prompt = `Suche 8 Top-B√ºcher f√ºr: "${searchTerm}". JSON: [{"title": "...", "author": "..."}]`;
                const aiResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME_TEXT}:generateContent?key=${apiKey}`, {
                  method: 'POST', headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
                });
                const list = parseAIResponse((await aiResponse.json()).candidates?.[0]?.content?.parts?.[0]?.text || "[]");
                setLoadingText('Lade Details...');
                const res = await fetchDetailsForList(list);
                res.length ? setBooks(res) : setError('Nichts gefunden.');
              } else {
                setLoadingText('');
                const q = overrideQuery ? `subject:${overrideQuery}` : searchTerm;
                const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}&maxResults=20`);
                const data = await res.json();
                data.items ? setBooks(Array.from(new Map(data.items.map(b => [b.id, b])).values())) : setError('Nichts gefunden.');
              }
            } catch (e) { setError('Fehler bei Suche.'); } finally { setLoading(false); }
          };

          const handleLoadMore = async () => {
            setLoadingMore(true);
            try {
                if (aiSearchMode) {
                    if (!apiKey) { showToastMessage("API Key fehlt!", "error"); setLoadingMore(false); return; }
                    const current = books.map(b => b.volumeInfo.title).slice(0, 50).join(", ");
                    const prompt = `Suche 8 WEITERE B√ºcher zu "${query}". Ignoriere: ${current}. JSON: [{"title": "...", "author": "..."}]`;
                    const aiRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME_TEXT}:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
                    });
                    const list = parseAIResponse((await aiRes.json()).candidates?.[0]?.content?.parts?.[0]?.text || "[]");
                    const newBooks = await fetchDetailsForList(list);
                    setBooks(prev => Array.from(new Map([...prev, ...newBooks].map(b => [b.id, b])).values()));
                } else {
                    const start = books.length;
                    const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=20&startIndex=${start}`);
                    const data = await res.json();
                    if (data.items) setBooks(prev => Array.from(new Map([...prev, ...data.items].map(b => [b.id, b])).values()));
                }
            } catch (e) { console.error(e); } finally { setLoadingMore(false); }
          };

          // --- IMPORT ---
          const handleImportFileChange = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            setLoading(true); setLoadingText('Lese Datei...');
            const reader = new FileReader();
            reader.onload = async (e) => {
              const content = e.target.result;
              setLoading(false);
              try {
                const imported = JSON.parse(content);
                if (Array.isArray(imported) && (imported.length === 0 || (imported[0]?.id && imported[0]?.volumeInfo))) {
                  const uniqueImport = Array.from(new Map(imported.map(item => [item.id, item])).values());
                  openConfirm("Backup Import", `${uniqueImport.length} B√ºcher gefunden. Importieren?`, async () => {
                     closeConfirm();
                     if (!user) return;
                     const batch = writeBatch(db);
                     let count = 0;
                     uniqueImport.forEach(book => {
                       if (book.aiCoverUrl && book.aiCoverUrl.length > 800000) delete book.aiCoverUrl;
                       const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'books', book.id);
                       batch.set(ref, book);
                       count++;
                     });
                     await batch.commit();
                     showToastMessage(`${count} B√ºcher importiert!`);
                  });
                  return;
                }
              } catch (err) { }
              openConfirm("Text Import", "Kein Backup-Format. KI-Analyse starten?", () => { closeConfirm(); processTextImport(content); });
            };
            reader.readAsText(file);
            event.target.value = null;
          };

          const processTextImport = async (textContent) => {
            setLoading(true); setLoadingText('KI analysiert Liste...');
            try {
              if (!apiKey) { showToastMessage("API Key fehlt!", "error"); setLoading(false); return; }
              const prompt = `Extrahiere B√ºcher aus Text: "${textContent.substring(0,8000)}". JSON Array: [{"title": "...", "author": "..."}]. Nur echte B√ºcher.`;
              const aiResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME_TEXT}:generateContent?key=${apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
              });
              const extractedList = parseAIResponse((await aiResponse.json()).candidates?.[0]?.content?.parts?.[0]?.text || "[]");
              if (extractedList.length === 0) throw new Error("Nichts gefunden.");
              setLoadingText(`Suche ${extractedList.length} B√ºcher...`);
              const foundBooks = await fetchDetailsForList(extractedList);
              if (foundBooks.length > 0 && user) {
                 const batch = writeBatch(db);
                 foundBooks.forEach(b => {
                   const newBook = { ...b, isRead: true, rating: 0, userNote: 'Importiert', addedAt: new Date().toISOString() };
                   const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'books', b.id);
                   batch.set(ref, newBook);
                 });
                 await batch.commit();
                 showToastMessage(`${foundBooks.length} B√ºcher importiert!`);
              } else { showToastMessage("Keine Treffer.", "error"); }
            } catch (err) { showToastMessage("Fehler beim Import.", "error"); } finally { setLoading(false); }
          };

          const handlePasteImport = async () => {
            if (!pasteText.trim()) return;
            setShowPasteModal(false);
            await processTextImport(pasteText);
            setPasteText('');
          };

          // --- RECOMMENDATIONS (MIT FILTER F√úR GELESENES) ---
          const getAiRecommendations = async (onlyRead = false, append = false) => {
            if (!apiKey) { showToastMessage("API Key fehlt!", "error"); return; }
            let src = onlyRead ? myLibrary.filter(b => b.isRead) : myLibrary;
            if (src.length === 0) { showToastMessage("Keine Basis f√ºr Empfehlungen.", "info"); return; }

            src = src.sort((a,b) => (b.rating || 0) - (a.rating || 0)).slice(0, 20);

            if (append) setLoadingMoreRecs(true);
            else { setLoadingRecs(true); setRecommendations([]); }

            setRecSource(onlyRead ? 'read' : 'all');

            try {
                const topRated = src.filter(b => b.rating >= 4).map(b => `"${b.volumeInfo.title}"`);
                const others = src.filter(b => !b.rating || b.rating < 4).map(b => `"${b.volumeInfo.title}"`);

                // Sammle ALLE Titel aus der Bibliothek (gelesen und ungelesen) um Dopplungen zu vermeiden
                const libraryTitles = myLibrary.map(b => b.volumeInfo.title);
                // Auch bereits angezeigte Empfehlungen ausschlie√üen
                const currentRecs = recommendations.map(r => r.title);
                const excludeList = [...new Set([...libraryTitles, ...currentRecs])].slice(0, 100).join(", ");

                const prompt = `Basierend auf Favoriten: ${topRated.join(', ')}.
                ${others.length > 0 ? `Auch im Regal: ${others.join(', ')}.` : ''}
                Empfehle 5 neue B√ºcher.
                WICHTIG: Empfiehl KEINESFALLS B√ºcher, die hier gelistet sind (bereits bekannt): ${excludeList}.
                Gib mir ein JSON Array zur√ºck: [{"title": "Titel", "reason": "Kurze Begr√ºndung"}]`;

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME_TEXT}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
                });

                let list = parseAIResponse((await res.json()).candidates?.[0]?.content?.parts?.[0]?.text || "[]");

                // Client-Side Filter: Doppelte Sicherheit, falls die AI halluziniert
                list = list.filter(rec => !myLibrary.some(libBook =>
                    libBook.volumeInfo.title.toLowerCase().includes(rec.title.toLowerCase()) ||
                    rec.title.toLowerCase().includes(libBook.volumeInfo.title.toLowerCase())
                ));

                if (append) setRecommendations(prev => [...prev, ...list]);
                else setRecommendations(list);

            } catch (e) { console.error(e); } finally { setLoadingRecs(false); setLoadingMoreRecs(false); }
          };

          const removeRecommendation = (titleToRemove) => {
              setRecommendations(prev => prev.filter(r => r.title !== titleToRemove));
          };

          const handleAddSequels = async (sequelList) => {
              if (!user) return;
              setLoading(true); setLoadingText(`Suche ${sequelList.length} B√ºcher...`);
              try {
                  const foundBooks = await fetchDetailsForList(sequelList);
                  if (foundBooks.length > 0) {
                      const batch = writeBatch(db);
                      foundBooks.forEach(b => {
                          const exists = myLibrary.some(ex => ex.id === b.id);
                          if (!exists) {
                              const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'books', b.id);
                              batch.set(ref, { ...b, isRead: true, rating: 0, userNote: 'Teil einer Reihe', addedAt: new Date().toISOString() });
                          }
                      });
                      await batch.commit();
                      showToastMessage(`${foundBooks.length} B√§nde hinzugef√ºgt!`);
                  } else { showToastMessage("Konnte B√§nde nicht finden.", "error"); }
              } catch (e) { showToastMessage("Fehler beim Hinzuf√ºgen.", "error"); } finally { setLoading(false); }
          };

          const getFilteredLibrary = () => {
            let filtered = [...myLibrary];
            if (libraryFilter === 'read') filtered = filtered.filter(b => b.isRead);
            else if (libraryFilter === 'unread') filtered = filtered.filter(b => !b.isRead);
            if (librarySearch.trim()) {
                const term = librarySearch.trim().toLowerCase();
                filtered = filtered.filter(b => {
                    const title = b.volumeInfo?.title || '';
                    const authors = b.volumeInfo?.authors?.join(', ') || '';
                    const categories = b.volumeInfo?.categories?.join(', ') || '';
                    const note = b.userNote || '';
                    return [title, authors, categories, note].some(field => field.toLowerCase().includes(term));
                });
            }
            return filtered.sort((a, b) => {
                if (sortOption === 'ratingDesc') return (b.rating || 0) - (a.rating || 0);
                if (sortOption === 'titleAsc') return a.volumeInfo.title.localeCompare(b.volumeInfo.title);
                return new Date(b.addedAt || 0) - new Date(a.addedAt || 0);
            });
          };

          const getLibraryStatus = (bookId) => {
            const book = myLibrary.find(b => b.id === bookId);
            return book ? { inLibrary: true, isRead: book.isRead, rating: book.rating || 0, userNote: book.userNote || '' } : { inLibrary: false, isRead: false, rating: 0, userNote: '' };
          };

          const handleDirectSearch = (term) => {
            setSelectedBook(null);
            setQuery(term);
            setActiveTab('search');
            setAiSearchMode(false);
            updateRecentSearches(term);
            searchBooks(null, term);
            window.scrollTo({ top: 0, behavior: 'smooth' });
          };

          const resetLibraryFilters = () => {
            setLibraryFilter('all');
            setLibrarySearch('');
            setSortOption('dateDesc');
          };

          const filteredLibrary = getFilteredLibrary();
          const libraryCounts = myLibrary.reduce((acc, book) => {
            if (book.isRead) acc.read += 1;
            else acc.unread += 1;
            return acc;
          }, { read: 0, unread: 0 });
          const totalLibrary = myLibrary.length;
          const readProgress = totalLibrary > 0 ? Math.round((libraryCounts.read / totalLibrary) * 100) : 0;
          const hasActiveLibraryFilters = libraryFilter !== 'all' || librarySearch.trim().length > 0;

          return (
            <div className={`min-h-screen font-sans transition-colors duration-300 ${darkMode ? 'bg-slate-900 text-slate-100' : 'bg-slate-50 text-slate-800'}`}>
              <header className={`sticky top-0 z-30 shadow-lg transition-colors duration-300 ${darkMode ? 'bg-indigo-900/95 backdrop-blur text-white' : 'bg-indigo-700 text-white'}`}>
                <div className="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row items-center justify-between gap-4">
                  <div className="flex items-center gap-3">
                    <div className="p-2 bg-white/10 rounded-xl"><BookOpen className="w-6 h-6" /></div>
                    <div>
                      <h1 className="text-2xl font-bold tracking-tight leading-none">Bibliothek</h1>
                      <span className="text-indigo-300 text-xs font-medium flex items-center gap-1 mt-0.5">v6.1 Ultimate</span>
                    </div>
                  </div>
                  <div className="flex items-center gap-2 md:gap-4 w-full md:w-auto overflow-x-auto">
                    <button onClick={() => setIsTimerRunning(!isTimerRunning)} className={`flex items-center gap-2 px-3 py-1 rounded-lg text-xs font-bold transition-all ${isTimerRunning ? 'bg-red-500 text-white animate-pulse' : 'bg-black/20 text-white/90'}`}>
                        {isTimerRunning ? <Pause className="w-3 h-3" /> : <Play className="w-3 h-3" />} {isTimerRunning ? 'Liest...' : 'Lesezeit'}
                    </button>
                    <div className="flex items-center gap-2 px-3 py-1 bg-black/20 rounded-lg text-xs font-bold text-white/90" title="Deine Lese-Str√§hne"><Flame className="w-4 h-4 text-orange-400 fill-current" /> {streak}</div>
                    <nav className={`flex p-1 rounded-xl shadow-inner ${darkMode ? 'bg-black/20' : 'bg-indigo-800/50'}`}>
                      <button onClick={() => { setActiveTab('search'); setShowStats(false); }} className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === 'search' && !showStats ? 'bg-white text-indigo-700 shadow-sm' : 'text-indigo-100 hover:bg-white/10'}`}>Suche</button>
                      <button onClick={() => { setActiveTab('library'); setShowStats(false); }} className={`px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${activeTab === 'library' && !showStats ? 'bg-white text-indigo-700 shadow-sm' : 'text-indigo-100 hover:bg-white/10'}`}>
                        B√ºcher {myLibrary.length > 0 && <span className={`text-xs px-1.5 py-0.5 rounded-full min-w-[1.25rem] text-center ${activeTab === 'library' && !showStats ? 'bg-indigo-100 text-indigo-700' : 'bg-indigo-500 text-white'}`}>{myLibrary.length}</span>}
                      </button>
                    </nav>
                    <button onClick={() => setShowSettings(true)} className={`p-2.5 rounded-xl transition-colors ${darkMode ? 'bg-slate-800 text-slate-300 hover:bg-slate-700' : 'bg-indigo-600 text-indigo-100 hover:bg-indigo-500'}`}><Settings className="w-5 h-5" /></button>
                    <button onClick={() => setDarkMode(!darkMode)} className={`p-2.5 rounded-xl transition-colors ${darkMode ? 'bg-slate-800 text-yellow-400 hover:bg-slate-700' : 'bg-indigo-600 text-indigo-100 hover:bg-indigo-500'}`}>{darkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}</button>
                  </div>
                </div>
              </header>

              <main className="max-w-7xl mx-auto px-4 py-8 relative">
                {toast.show && (
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-[60] animate-in slide-in-from-bottom-4 fade-in duration-300 pointer-events-none">
                        <div className={`px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 border ${darkMode ? 'bg-slate-800 text-white border-slate-700' : 'bg-white text-slate-800 border-slate-200'}`}>
                            {toast.type === 'success' ? <CheckCircle className="w-5 h-5 text-green-500" /> : toast.type === 'error' ? <AlertTriangle className="w-5 h-5 text-red-500" /> : <Info className="w-5 h-5 text-indigo-500" />}
                            <span className="font-medium">{toast.message}</span>
                        </div>
                    </div>
                )}

                {confirmModal.show && (
                  <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in">
                     <div className={`w-full max-w-md rounded-2xl shadow-2xl p-6 relative animate-in zoom-in-95 ${darkMode ? 'bg-slate-800 text-slate-100' : 'bg-white text-slate-800'}`}>
                        <h3 className="text-xl font-bold mb-2 flex items-center gap-2">{confirmModal.isDestructive ? <AlertTriangle className="w-6 h-6 text-red-500" /> : <Info className="w-6 h-6 text-indigo-500" />} {confirmModal.title}</h3>
                        <p className={`mb-6 text-sm whitespace-pre-line ${darkMode ? 'text-slate-300' : 'text-slate-600'}`}>{confirmModal.message}</p>
                        <div className="flex justify-end gap-3">
                           <button onClick={closeConfirm} className={`px-4 py-2 rounded-lg font-medium ${darkMode ? 'hover:bg-slate-700' : 'hover:bg-slate-100 text-slate-600'}`}>Abbrechen</button>
                           <button onClick={confirmModal.onConfirm} className={`px-5 py-2 rounded-lg font-bold text-white shadow-md transition-transform active:scale-95 ${confirmModal.isDestructive ? 'bg-red-600 hover:bg-red-700' : 'bg-indigo-600 hover:bg-indigo-700'}`}>Best√§tigen</button>
                        </div>
                     </div>
                  </div>
                )}

                {showPasteModal && (
                  <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in">
                     <div className={`w-full max-w-2xl rounded-2xl shadow-2xl p-6 relative animate-in zoom-in-95 ${darkMode ? 'bg-slate-800 text-slate-100' : 'bg-white text-slate-800'}`}>
                        <button onClick={() => setShowPasteModal(false)} className="absolute top-4 right-4 p-2 opacity-50 hover:opacity-100"><X className="w-5 h-5" /></button>
                        <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><ClipboardPaste className="w-6 h-6 text-indigo-500" /> Text Import</h2>
                        <textarea value={pasteText} onChange={(e) => setPasteText(e.target.value)} placeholder="Liste hier einf√ºgen..." className={`w-full h-48 p-4 rounded-xl border mb-4 text-sm font-mono ${darkMode ? 'bg-slate-900 border-slate-700 text-slate-300' : 'bg-slate-50 border-slate-300'}`} />
                        <div className="flex justify-end gap-3">
                            <button onClick={() => setShowPasteModal(false)} className={`px-4 py-2 rounded-lg font-medium ${darkMode ? 'hover:bg-slate-700' : 'hover:bg-slate-100'}`}>Abbrechen</button>
                            <button onClick={() => { setShowPasteModal(false); processTextImport(pasteText); setPasteText(''); }} disabled={!pasteText.trim()} className="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 disabled:opacity-50 flex items-center gap-2"><Sparkles className="w-4 h-4" /> Import</button>
                        </div>
                     </div>
                  </div>
                )}

                {loading && (
                   <div className="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/50 backdrop-blur-sm">
                      <div className="bg-white p-6 rounded-2xl flex flex-col items-center shadow-2xl animate-in zoom-in-95">
                        <div className="p-3 bg-indigo-100 rounded-full mb-3"><Sparkles className="w-8 h-8 text-indigo-600 animate-pulse" /></div>
                        <p className="text-lg font-bold text-slate-800">{loadingText || 'Laden...'}</p>
                      </div>
                   </div>
                )}

                {showStats && <StatsDashboard library={myLibrary} goal={readingGoal} setGoal={setReadingGoal} onClose={() => setShowStats(false)} darkMode={darkMode} streak={streak} totalMinutes={Math.floor(totalMinutesRead)} onAddMinutes={addReadingMinutes} />}

                {activeTab === 'search' && !showStats && (
                  <div className="animate-in slide-in-from-top-4 duration-500">
                    <div className="max-w-3xl mx-auto mb-8">
                      <div className={`p-3 rounded-2xl shadow-sm border ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                        <form onSubmit={(e) => searchBooks(e)} className="relative flex items-center">
                          <Search className={`absolute left-4 w-6 h-6 ${aiSearchMode ? 'text-violet-500' : 'text-slate-400'}`} />
                          <input type="text" value={query} onChange={(e) => setQuery(e.target.value)} placeholder={aiSearchMode ? "Beschreibe dein Buch..." : "Titel, Autor..."} className={`w-full pl-12 pr-4 py-3 rounded-xl border-none focus:ring-0 text-lg outline-none bg-transparent ${darkMode ? 'text-white placeholder:text-slate-500' : 'text-slate-800 placeholder:text-slate-300'}`} />
                          <button type="button" onClick={() => setAiSearchMode(!aiSearchMode)} className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold mx-2 border ${aiSearchMode ? 'bg-violet-100 text-violet-700 border-violet-200 dark:bg-violet-900/50 dark:text-violet-300' : 'bg-slate-50 text-slate-400 border-slate-200 dark:bg-slate-700'}`}>{aiSearchMode ? 'KI AN' : 'KI AUS'}</button>
                          <button type="submit" disabled={loading} className={`ml-2 px-6 py-2 rounded-xl font-medium text-white transition-all shadow-md flex items-center gap-2 ${aiSearchMode ? 'bg-gradient-to-r from-violet-600 to-fuchsia-600' : 'bg-indigo-600'}`}>{loading ? <Loader2 className="w-5 h-5 animate-spin" /> : 'Suchen'}</button>
                        </form>
                      </div>
                    </div>

                    <div className="max-w-4xl mx-auto mb-8 flex flex-wrap justify-center gap-2">
                        {CATEGORIES.map(cat => (
                          <button key={cat} onClick={() => searchBooks(null, cat)} className={`px-4 py-1.5 border rounded-full text-sm font-medium transition-all shadow-sm active:scale-95 ${aiSearchMode ? 'bg-violet-50 text-violet-700 border-violet-200 hover:bg-violet-100 dark:bg-violet-900/30 dark:text-violet-200 dark:border-violet-700' : darkMode ? 'bg-slate-800 text-slate-300 border-slate-700 hover:bg-slate-700' : 'bg-white text-slate-600 border-slate-200 hover:bg-indigo-50'}`}>{cat}</button>
                        ))}
                    </div>

                    {recentSearches.length > 0 && (
                      <div className="max-w-4xl mx-auto mb-8 flex flex-wrap items-center justify-center gap-2 text-xs">
                        <span className={`mr-2 uppercase tracking-wider font-bold ${darkMode ? 'text-slate-400' : 'text-slate-500'}`}>Zuletzt gesucht</span>
                        {recentSearches.map((term) => (
                          <button key={term} onClick={() => searchBooks(null, term)} className={`px-3 py-1 rounded-full border text-xs font-semibold transition-all ${darkMode ? 'bg-slate-800 text-slate-300 border-slate-700 hover:bg-slate-700' : 'bg-white text-slate-600 border-slate-200 hover:bg-indigo-50'}`}>
                            {term}
                          </button>
                        ))}
                        <button onClick={() => setRecentSearches([])} className={`ml-2 px-2.5 py-1 rounded-full border text-xs font-semibold transition-all ${darkMode ? 'bg-slate-800 text-slate-400 border-slate-700 hover:bg-slate-700' : 'bg-slate-50 text-slate-500 border-slate-200 hover:bg-slate-100'}`}>
                          L√∂schen
                        </button>
                      </div>
                    )}

                    {books.length > 0 ? (
                      <>
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 mb-10">
                          {books.map(b => <BookCard key={b.id} book={b} status={getLibraryStatus(b.id)} onSelect={() => setSelectedBook(b)} onToggleLibrary={() => getLibraryStatus(b.id).inLibrary ? removeFromLibrary(b.id) : addToLibrary(b)} onToggleRead={() => toggleReadStatus(b)} onUpdateData={(changes) => updateBookData(b.id, changes)} getThumbnail={b => b.aiCoverUrl || b.volumeInfo.imageLinks?.thumbnail || null} darkMode={darkMode} apiKey={apiKey} />)}
                        </div>
                        <div className="flex justify-center pb-12"><button onClick={handleLoadMore} disabled={loadingMore} className={`flex items-center gap-2 px-8 py-3 rounded-full font-bold shadow-lg transition-all text-white ${aiSearchMode ? 'bg-gradient-to-r from-violet-600 to-fuchsia-600' : 'bg-indigo-600 hover:bg-indigo-700'}`}>{loadingMore ? <Loader2 className="animate-spin w-5 h-5" /> : <ArrowDownCircle className="w-5 h-5" />} Mehr</button></div>
                      </>
                    ) : !loading && !error && (
                      <div className="text-center py-20 opacity-60">
                        <div className={`w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 ${darkMode ? 'bg-slate-800' : 'bg-slate-100'}`}>{aiSearchMode ? <BrainCircuit className="w-10 h-10 text-violet-400" /> : <Rocket className="w-10 h-10 text-slate-400" />}</div>
                        <p className="text-xl font-medium">Bereit zum St√∂bern</p>
                      </div>
                    )}
                  </div>
                )}

                {activeTab === 'library' && !showStats && (
                  <div className="animate-in fade-in duration-300">
                    <div className={`p-4 rounded-2xl shadow-sm border mb-8 flex flex-col lg:flex-row items-center justify-between gap-4 ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                      <div className="flex items-center gap-2 w-full lg:w-auto overflow-x-auto pb-2 lg:pb-0">
                        {['all', 'unread', 'read'].map(f => <button key={f} onClick={() => setLibraryFilter(f)} className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap capitalize transition-colors ${libraryFilter === f ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-200' : 'text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-700'}`}>{f === 'all' ? 'Alle' : f === 'unread' ? 'Ungelesen' : 'Gelesen'}</button>)}
                        <div className="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-2"></div>
                        <div className="relative group">
                            <button className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${darkMode ? 'hover:bg-slate-700 text-slate-300' : 'hover:bg-slate-100 text-slate-600'}`}><SortAsc className="w-4 h-4" /> Sortieren</button>
                            <div className={`absolute top-full left-0 mt-2 w-40 rounded-xl shadow-xl border p-1 hidden group-hover:block z-20 ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}>
                                <button onClick={() => setSortOption('dateDesc')} className={`w-full text-left px-3 py-2 rounded-lg text-xs ${sortOption === 'dateDesc' ? 'bg-indigo-100 text-indigo-700' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}>Neueste</button>
                                <button onClick={() => setSortOption('ratingDesc')} className={`w-full text-left px-3 py-2 rounded-lg text-xs ${sortOption === 'ratingDesc' ? 'bg-indigo-100 text-indigo-700' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}>Bewertung</button>
                                <button onClick={() => setSortOption('titleAsc')} className={`w-full text-left px-3 py-2 rounded-lg text-xs ${sortOption === 'titleAsc' ? 'bg-indigo-100 text-indigo-700' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}>A-Z</button>
                            </div>
                        </div>
                        <button onClick={() => setShowStats(true)} aria-label="Statistiken √∂ffnen" title="Statistiken √∂ffnen" className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors ${darkMode ? 'hover:bg-slate-700 text-yellow-400' : 'hover:bg-amber-50 text-amber-600'}`}><BarChart3 className="w-4 h-4" /></button>
                      </div>

                      <div className="flex flex-wrap items-center gap-2 w-full lg:w-auto justify-end">
                        <div className="relative w-full sm:w-60">
                          <Search className={`absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 ${darkMode ? 'text-slate-400' : 'text-slate-400'}`} />
                          <input
                            type="text"
                            value={librarySearch}
                            onChange={(e) => setLibrarySearch(e.target.value)}
                            placeholder="In Bibliothek suchen..."
                            aria-label="Bibliothek durchsuchen"
                            className={`w-full pl-9 pr-8 py-2 rounded-lg text-xs font-medium border outline-none transition-colors ${darkMode ? 'bg-slate-900 border-slate-700 text-slate-200 placeholder:text-slate-500 focus:border-indigo-500' : 'bg-white border-slate-200 text-slate-700 placeholder:text-slate-400 focus:border-indigo-500'}`}
                          />
                          {librarySearch && (
                            <button
                              onClick={() => setLibrarySearch('')}
                              className={`absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded-full ${darkMode ? 'text-slate-400 hover:text-slate-200' : 'text-slate-400 hover:text-slate-600'}`}
                              aria-label="Suchfeld leeren"
                            >
                              <X className="w-3 h-3" />
                            </button>
                          )}
                        </div>
                        <button onClick={pickRandomBook} className={`p-2 rounded-lg border transition-colors flex items-center gap-2 px-3 text-xs font-bold ${darkMode ? 'bg-slate-700 border-slate-600 hover:bg-slate-600 text-purple-400' : 'bg-slate-50 border-slate-200 hover:bg-slate-100 text-purple-600'}`} title="Zufallsbuch"><Shuffle className="w-4 h-4" /> √úberrasch mich</button>
                        <div className="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-2"></div>
                        <button onClick={() => setShowPasteModal(true)} className={`p-2 rounded-lg border transition-colors flex items-center gap-2 px-3 text-xs font-bold ${darkMode ? 'bg-slate-700 border-slate-600 hover:bg-slate-600' : 'bg-slate-50 border-slate-200 hover:bg-slate-100'}`}><FileText className="w-4 h-4" /> Text</button>
                        <button onClick={() => { fileInputRef.current.value = ''; fileInputRef.current.click() }} className={`p-2 rounded-lg border transition-colors flex items-center gap-2 px-3 text-xs font-bold ${darkMode ? 'bg-slate-700 border-slate-600 hover:bg-slate-600' : 'bg-slate-50 border-slate-200 hover:bg-slate-100'}`}><Upload className="w-4 h-4" /> Datei</button>
                        <input type="file" ref={fileInputRef} onChange={handleImportFileChange} className="hidden" accept=".json,.txt,.csv" />
                        <button onClick={() => { const b = new Blob([JSON.stringify(myLibrary)],{type:'application/json'}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download='lib.json'; a.click(); }} className={`p-2 rounded-lg border transition-colors ${darkMode ? 'bg-slate-700 border-slate-600 hover:bg-slate-600' : 'bg-slate-50 border-slate-200 hover:bg-slate-100'}`}><Download className="w-4 h-4" /></button>
                        {myLibrary.length > 0 && (
                          <>
                            <button onClick={() => getAiRecommendations(false, false)} disabled={loadingRecs} className="flex items-center gap-2 bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-200 hover:bg-indigo-200 px-4 py-2 rounded-lg text-sm font-medium">{loadingRecs && recSource === 'all' && !loadingMoreRecs ? <Loader2 className="animate-spin w-4 h-4" /> : <Sparkles className="w-4 h-4" />} Tipps</button>
                            <button onClick={() => getAiRecommendations(true, false)} disabled={loadingRecs} className="flex items-center gap-2 bg-gradient-to-r from-violet-600 to-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg text-sm font-medium">{loadingRecs && recSource === 'read' ? <Loader2 className="animate-spin w-4 h-4" /> : <CheckCircle className="w-4 h-4" />} Gelesenes</button>
                          </>
                        )}
                      </div>
                    </div>
                    <div className={`mb-6 flex flex-wrap items-center justify-between gap-4 text-xs font-semibold ${darkMode ? 'text-slate-300' : 'text-slate-600'}`}>
                      <div className="flex flex-wrap items-center gap-4">
                        <span className={`px-3 py-1 rounded-full border ${darkMode ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-white'}`}>
                          Treffer: {filteredLibrary.length}
                        </span>
                        <span className={`px-3 py-1 rounded-full border ${darkMode ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-white'}`}>
                          Gelesen: {libraryCounts.read}
                        </span>
                        <span className={`px-3 py-1 rounded-full border ${darkMode ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-white'}`}>
                          Ungelesen: {libraryCounts.unread}
                        </span>
                        <span className={`px-3 py-1 rounded-full border ${darkMode ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-white'}`}>
                          Fortschritt: {readProgress}%
                        </span>
                      </div>
                      {hasActiveLibraryFilters && (
                        <button
                          onClick={resetLibraryFilters}
                          className={`inline-flex items-center gap-2 px-3 py-1 rounded-full border transition-colors ${darkMode ? 'border-slate-600 text-slate-200 hover:bg-slate-700' : 'border-slate-200 text-slate-600 hover:bg-slate-50'}`}
                        >
                          Filter zur√ºcksetzen
                        </button>
                      )}
                    </div>

                    {recommendations.length > 0 && (
                      <div className={`mb-10 rounded-2xl p-6 border animate-in slide-in-from-top-4 ${darkMode ? 'bg-indigo-900/20 border-indigo-800' : 'bg-indigo-50 border-indigo-100'}`}>
                        <div className="flex justify-between items-center mb-4">
                          <h3 className={`font-bold flex items-center gap-2 ${darkMode ? 'text-indigo-300' : 'text-indigo-900'}`}><Sparkles className="w-5 h-5" /> Vorschl√§ge</h3>
                          <button onClick={() => setRecommendations([])}><X className="w-5 h-5 opacity-50 hover:opacity-100" /></button>
                        </div>
                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                          {recommendations.map((rec, i) => (
                            <div key={i} className={`p-4 rounded-xl border shadow-sm relative group ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-indigo-50'}`}>
                              <button onClick={() => removeRecommendation(rec.title)} className="absolute top-2 right-2 p-1 text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><X className="w-4 h-4" /></button>
                              <h4 className="font-bold mb-2 pr-6">{rec.title}</h4>
                              <p className={`text-sm mb-3 flex items-start gap-2 ${darkMode ? 'text-slate-400' : 'text-slate-600'}`}><Lightbulb className="w-4 h-4 text-amber-500 shrink-0" /> {rec.reason}</p>
                              <button onClick={() => { setSelectedBook(null); setQuery(rec.title); setActiveTab('search'); setAiSearchMode(false); searchBooks(null, rec.title); window.scrollTo({ top: 0, behavior: 'smooth' }); }} className="text-xs text-indigo-500 font-bold hover:underline">Suchen &rarr;</button>
                            </div>
                          ))}
                        </div>
                        <div className="flex justify-center">
                            <button onClick={() => getAiRecommendations(recSource === 'read', true)} disabled={loadingMoreRecs} className={`flex items-center gap-2 px-4 py-2 rounded-full text-sm font-bold transition-all ${darkMode ? 'bg-indigo-900/50 hover:bg-indigo-800 text-indigo-200' : 'bg-indigo-100 hover:bg-indigo-200 text-indigo-700'}`}>
                                {loadingMoreRecs ? <Loader2 className="w-4 h-4 animate-spin" /> : <RefreshCw className="w-4 h-4" />} Mehr Tipps laden
                            </button>
                        </div>
                      </div>
                    )}

                    {filteredLibrary.length > 0 ? (
                      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                        {filteredLibrary.map(b => (
                          <BookCard
                            key={b.id}
                            book={b}
                            status={getLibraryStatus(b.id)}
                            onSelect={() => setSelectedBook(b)}
                            onToggleLibrary={() => removeFromLibrary(b.id)}
                            onToggleRead={() => toggleReadStatus(b)}
                            onUpdateData={(changes) => updateBookData(b.id, changes)}
                            getThumbnail={b => b.aiCoverUrl || b.volumeInfo.imageLinks?.thumbnail || null}
                            darkMode={darkMode}
                            apiKey={apiKey}
                          />
                        ))}
                      </div>
                    ) : (
                      <div className={`text-center py-20 rounded-xl border border-dashed ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-300'}`}>
                        {myLibrary.length > 0 ? (
                          <>
                            <Filter className="w-14 h-14 mx-auto mb-4 opacity-30" />
                            <p className="text-xl font-medium opacity-70">Keine Treffer gefunden.</p>
                            <p className="text-sm opacity-60 mt-2">Passe deine Filter oder Suche an.</p>
                            {librarySearch && (
                              <button
                                onClick={() => setLibrarySearch('')}
                                className={`mt-4 inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold border ${darkMode ? 'border-slate-600 text-slate-200 hover:bg-slate-700' : 'border-slate-200 text-slate-600 hover:bg-slate-50'}`}
                              >
                                Suche zur√ºcksetzen
                              </button>
                            )}
                          </>
                        ) : (
                          <>
                            <Library className="w-16 h-16 mx-auto mb-4 opacity-30" />
                            <p className="text-xl font-medium opacity-70">Leer hier.</p>
                          </>
                        )}
                      </div>
                    )}
                  </div>
                )}
              </main>

              {selectedBook && (
                <BookModal
                  book={selectedBook}
                  onClose={() => setSelectedBook(null)}
                  status={getLibraryStatus(selectedBook.id)}
                  onToggleLibrary={() => { const s = getLibraryStatus(selectedBook.id); s.inLibrary ? removeFromLibrary(selectedBook.id) : addToLibrary(selectedBook); }}
                  onToggleRead={() => toggleReadStatus(selectedBook)}
                  onUpdateData={(changes) => updateBookData(selectedBook.id, changes)}
                  onSearch={handleDirectSearch}
                  onAddSequels={handleAddSequels}
                  getThumbnail={b => b.aiCoverUrl || b.volumeInfo.imageLinks?.thumbnail || null}
                  darkMode={darkMode}
                  apiKey={apiKey}
                />
              )}
            </div>
          );
        }

        // --- SUB-COMPONENTS ---

        function StatsDashboard({ library, onClose, darkMode, goal, setGoal, streak, totalMinutes, onAddMinutes }) {
          const readBooks = library.filter(b => b.isRead);
          const totalPages = readBooks.reduce((sum, b) => sum + (b.volumeInfo?.pageCount || 0), 0);
          const ratedBooks = library.filter(b => b.rating > 0);
          const avgRating = ratedBooks.length > 0 ? (ratedBooks.reduce((s, b) => s + b.rating, 0) / ratedBooks.length).toFixed(1) : 0;
          const progress = Math.min(100, Math.round((readBooks.length / goal) * 100));

          // Genre Stats (Simple)
          const genres = {};
          readBooks.forEach(b => {
              const cats = b.volumeInfo?.categories || ['Sonstige'];
              cats.forEach(c => genres[c] = (genres[c] || 0) + 1);
          });
          const topGenres = Object.entries(genres).sort((a,b) => b[1] - a[1]).slice(0, 3);

          const badges = [
              { id: 1, icon: <BookOpen className="w-5 h-5" />, title: "Start", active: readBooks.length >= 1 },
              { id: 2, icon: <Trophy className="w-5 h-5" />, title: "Profi", active: readBooks.length >= 10 },
              { id: 3, icon: <Flame className="w-5 h-5" />, title: "Feuer", active: streak >= 3 },
              { id: 4, icon: <Clock className="w-5 h-5" />, title: "Zeit", active: totalMinutes >= 300 },
          ];

          return (
            <div className="animate-in fade-in zoom-in-95 duration-200 mb-8">
              <div className={`p-6 rounded-2xl shadow-xl border relative overflow-hidden ${darkMode ? 'bg-gradient-to-br from-indigo-900 to-slate-900 border-indigo-700' : 'bg-gradient-to-br from-indigo-600 to-violet-600 text-white border-transparent'}`}>
                <button onClick={onClose} className="absolute top-4 right-4 p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors"><X className="w-5 h-5 text-white" /></button>
                <h2 className="text-2xl font-bold mb-6 flex items-center gap-2 text-white"><BarChart3 className="w-6 h-6" /> Lese-Statistik</h2>

                <div className="mb-6 bg-white/10 p-4 rounded-xl backdrop-blur-sm border border-white/10">
                    <div className="flex justify-between items-end mb-2">
                        <div className="flex items-center gap-2"><Trophy className="w-5 h-5 text-yellow-300" /><span className="font-bold text-white">Jahresziel</span></div>
                        <div className="flex items-center gap-2">
                            <button onClick={() => setGoal(Math.max(1, goal - 1))} className="w-6 h-6 flex items-center justify-center bg-white/20 rounded hover:bg-white/30">-</button>
                            <span className="font-bold text-white w-8 text-center">{goal}</span>
                            <button onClick={() => setGoal(goal + 1)} className="w-6 h-6 flex items-center justify-center bg-white/20 rounded hover:bg-white/30">+</button>
                        </div>
                    </div>
                    <div className="w-full bg-black/20 rounded-full h-4 overflow-hidden relative"><div className="bg-yellow-400 h-full transition-all duration-1000 ease-out" style={{ width: `${progress}%` }}></div></div>
                    <p className="text-xs text-white/70 mt-2 text-right">{readBooks.length} von {goal} B√ºchern ({progress}%)</p>
                </div>

                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                  <div className="bg-white/10 p-4 rounded-xl backdrop-blur-sm border border-white/10"><p className="text-indigo-200 text-xs font-bold uppercase tracking-wider mb-1">Streak</p><p className="text-2xl font-bold text-white flex items-center gap-1">{streak} <Flame className="w-4 h-4 text-orange-400 fill-current" /></p></div>
                  <div className="bg-white/10 p-4 rounded-xl backdrop-blur-sm border border-white/10"><p className="text-indigo-200 text-xs font-bold uppercase tracking-wider mb-1">Gelesen</p><p className="text-2xl font-bold text-white">{readBooks.length}</p></div>
                  <div className="bg-white/10 p-4 rounded-xl backdrop-blur-sm border border-white/10"><p className="text-indigo-200 text-xs font-bold uppercase tracking-wider mb-1">Zeit</p><p className="text-2xl font-bold text-white">{Math.floor(totalMinutes / 60)}h {Math.floor(totalMinutes % 60)}m</p></div>
                  <div className="bg-white/10 p-4 rounded-xl backdrop-blur-sm border border-white/10"><p className="text-indigo-200 text-xs font-bold uppercase tracking-wider mb-1">Genres</p>
                     <div className="text-xs text-white space-y-1">
                         {topGenres.map(([g, c], i) => <div key={i} className="flex justify-between"><span>{g.split('/')[0].substring(0,10)}</span><span className="font-bold">{c}</span></div>)}
                         {topGenres.length === 0 && <span className="opacity-50">Keine Daten</span>}
                     </div>
                  </div>
                </div>

                <div className="mb-6 bg-white/10 p-4 rounded-xl backdrop-blur-sm border border-white/10">
                  <div className="flex flex-wrap items-center justify-between gap-3 mb-3">
                    <div className="flex items-center gap-2 text-white font-bold"><Clock className="w-4 h-4" /> Lesezeit buchen</div>
                    <span className="text-xs text-white/70">Gesamt: {Math.floor(totalMinutes / 60)}h {Math.floor(totalMinutes % 60)}m</span>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    {[5, 15, 30, 60].map((minutes) => (
                      <button
                        key={minutes}
                        onClick={() => onAddMinutes(minutes)}
                        className="px-3 py-1.5 rounded-full text-xs font-bold bg-white/20 hover:bg-white/30 text-white transition"
                      >
                        +{minutes}m
                      </button>
                    ))}
                  </div>
                </div>

                <div>
                    <h3 className="text-sm font-bold text-indigo-200 uppercase tracking-wider mb-3 flex items-center gap-2"><Award className="w-4 h-4" /> Erfolge</h3>
                    <div className="flex gap-4 overflow-x-auto pb-2">
                        {badges.map(badge => (
                            <div key={badge.id} className={`flex flex-col items-center justify-center p-3 rounded-xl min-w-[80px] border ${badge.active ? 'bg-yellow-400/20 border-yellow-400/50 text-yellow-100' : 'bg-black/20 border-white/5 text-white/30 grayscale'}`}>
                                <div className={`p-2 rounded-full mb-1 ${badge.active ? 'bg-yellow-400 text-yellow-900' : 'bg-white/10'}`}>{badge.icon}</div>
                                <span className="text-[10px] font-bold text-center">{badge.title}</span>
                            </div>
                        ))}
                    </div>
                </div>
              </div>
            </div>
          );
        }

        function SettingsModal({ apiKey, setApiKey, onClose, darkMode }) {
            const [key, setKey] = useState(apiKey);
            const handleSave = () => {
                setApiKey(key);
                localStorage.setItem('gemini_api_key', key);
                onClose();
            };
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in">
                    <div className={`w-full max-w-md rounded-2xl shadow-2xl p-6 relative animate-in zoom-in-95 ${darkMode ? 'bg-slate-800 text-slate-100' : 'bg-white text-slate-800'}`}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold flex items-center gap-2"><Settings className="w-6 h-6 text-indigo-500" /> Einstellungen</h3>
                            <button onClick={onClose} className="p-2 opacity-50 hover:opacity-100"><X className="w-5 h-5" /></button>
                        </div>
                        <div className="mb-6">
                            <label className="block text-sm font-bold mb-2">Google Gemini API Key</label>
                            <input type="password" value={key} onChange={(e) => setKey(e.target.value)} placeholder="API Key eingeben..." className={`w-full p-3 rounded-xl border outline-none focus:ring-2 focus:ring-indigo-500 ${darkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-slate-50 border-slate-300'}`} />
                            <p className="text-xs mt-2 opacity-70">Der Key wird lokal im Browser gespeichert.</p>
                        </div>
                        <div className="flex justify-end gap-3">
                            <button onClick={onClose} className={`px-4 py-2 rounded-lg font-medium ${darkMode ? 'hover:bg-slate-700' : 'hover:bg-slate-100'}`}>Abbrechen</button>
                            <button onClick={handleSave} className="px-5 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 shadow-md">Speichern</button>
                        </div>
                    </div>
                </div>
            );
        }

        function BookCard({ book, onSelect, status, onToggleLibrary, onToggleRead, onUpdateData, getThumbnail, darkMode, apiKey }) {
          const thumbnail = getThumbnail(book);
          const { title, authors } = book.volumeInfo;
          const { inLibrary, isRead, rating } = status;
          const [generating, setGenerating] = useState(false);

          const generateCover = async (e) => {
            e.stopPropagation();
            setGenerating(true);
            try {
              const prompt = `Buchcover Design f√ºr "${title}" von ${authors?.join(', ') || 'Unbekannt'}. Minimalistisch, √§sthetisch, hohe Qualit√§t.`;
              const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME_IMAGE}:predict?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ instances: [{ prompt: prompt }], parameters: { sampleCount: 1 } })
              });
              const data = await response.json();
              const base64 = data.predictions?.[0]?.bytesBase64Encoded;
              if (base64) {
                const compressedBase64 = await compressSmart(`data:image/png;base64,${base64}`);
                if (compressedBase64) onUpdateData({ aiCoverUrl: compressedBase64 });
              }
            } catch (err) { console.error("Cover Gen Error", err); } finally { setGenerating(false); }
          };

          const enhanceCover = async (e) => {
              e.stopPropagation();
              setGenerating(true);
              try {
                  if (!book.aiCoverUrl) {
                      alert("Nur selbst erstellte AI-Cover k√∂nnen verbessert werden.");
                      setGenerating(false);
                      return;
                  }
                  let base64 = book.aiCoverUrl.split(',')[1];
                  const prompt = "Make this image sharper, high resolution, highly detailed, better quality.";
                  const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME_EDIT}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64 } }] }], generationConfig: { responseModalities: ["IMAGE"] } })
                  });
                  const data = await response.json();
                  const newBase64 = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                  if (newBase64) {
                      const compressed = await compressSmart(`data:image/png;base64,${newBase64}`);
                      if (compressed) onUpdateData({ aiCoverUrl: compressed });
                  } else { alert("Fehler beim Sch√§rfen."); }
              } catch (e) { console.error(e); } finally { setGenerating(false); }
          };

          return (
            <div className={`group relative rounded-xl shadow-sm hover:shadow-xl transition-all duration-300 flex flex-col h-full border overflow-hidden ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'} ${isRead ? (darkMode ? 'border-green-800' : 'border-green-200 bg-green-50/30') : ''}`}>
              <div className={`relative aspect-[2/3] cursor-pointer overflow-hidden ${darkMode ? 'bg-slate-700' : 'bg-slate-200'}`} onClick={onSelect}>
                {thumbnail ? <img src={thumbnail} alt={title} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" /> :
                  <div className="w-full h-full flex flex-col items-center justify-center p-4 text-center relative">
                    <Book className="w-12 h-12 mb-2 opacity-30" /><span className="text-xs opacity-50 mb-4">Kein Bild</span>
                    <button onClick={generateCover} disabled={generating} className={`flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-bold shadow-sm transition-all z-10 ${darkMode ? 'bg-violet-600 text-white' : 'bg-white text-violet-600'}`}>{generating ? <Loader2 className="w-3 h-3 animate-spin" /> : <Palette className="w-3 h-3" />} {generating ? '...' : 'AI Cover'}</button>
                  </div>
                }
                <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-3 p-4 z-20">
                    <button onClick={generateCover} disabled={generating} className="flex items-center gap-2 px-4 py-2 bg-white text-slate-900 rounded-full text-xs font-bold hover:bg-indigo-50 w-full justify-center shadow-lg transform hover:scale-105 transition-all">{generating ? <Loader2 className="w-3 h-3 animate-spin" /> : <RefreshCw className="w-3 h-3" />} Neu malen</button>
                    <button onClick={enhanceCover} disabled={generating} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-full text-xs font-bold hover:bg-indigo-500 w-full justify-center shadow-lg transform hover:scale-105 transition-all">{generating ? <Loader2 className="w-3 h-3 animate-spin" /> : <Wand2 className="w-3 h-3" />} Sch√§rfen</button>
                </div>
                <div className="absolute top-2 right-2 flex flex-col gap-2 z-10">{isRead && <span className="bg-green-500 text-white p-1.5 rounded-full shadow-lg"><CheckCircle className="w-4 h-4" /></span>}</div>
                {inLibrary && rating > 0 && <div className="absolute bottom-0 left-0 right-0 bg-black/60 backdrop-blur-sm p-1 flex justify-center gap-0.5 z-10">{[...Array(5)].map((_, i) => <Star key={i} className={`w-3 h-3 ${i < rating ? 'text-yellow-400 fill-current' : 'text-slate-500'}`} />)}</div>}
              </div>
              <div className="p-4 flex-1 flex flex-col">
                <h3 className={`font-bold leading-tight mb-1 line-clamp-2 cursor-pointer hover:text-indigo-500 ${darkMode ? 'text-slate-100' : 'text-slate-800'}`} onClick={onSelect} title={title}>{title}</h3>
                <p className={`text-sm mb-2 line-clamp-1 ${darkMode ? 'text-slate-400' : 'text-slate-500'}`}>{authors ? authors.join(', ') : 'Unbekannt'}</p>
                <div className={`mt-auto pt-3 flex items-center justify-between border-t gap-2 ${darkMode ? 'border-slate-700' : 'border-slate-50'}`}>
                  <button onClick={(e) => { e.stopPropagation(); onToggleRead(); }} className={`p-2 rounded-full transition-colors ${isRead ? 'text-green-500 bg-green-500/10' : 'text-slate-400 hover:text-green-500 hover:bg-green-500/10'}`}><CheckCircle className="w-5 h-5" /></button>
                  <button onClick={(e) => { e.stopPropagation(); onToggleLibrary(); }} className={`p-2 rounded-full transition-colors ${inLibrary ? 'text-red-500 bg-red-500/10' : 'text-slate-400 hover:text-red-500 hover:bg-red-500/10'}`}><Heart className={`w-5 h-5 ${inLibrary ? 'fill-current' : ''}`} /></button>
                </div>
              </div>
            </div>
          );
        }

        function BookModal({ book, onClose, status, onToggleLibrary, onToggleRead, onUpdateData, onSearch, onAddSequels, getThumbnail, darkMode, apiKey }) {
          const info = book.volumeInfo;
          const thumbnail = getThumbnail(book);
          const { inLibrary, isRead, rating, userNote } = status;
          const [aiAnalysis, setAiAnalysis] = useState(null);
          const [aiLoading, setAiLoading] = useState(false);
          const [editNote, setEditNote] = useState(false);
          const [noteText, setNoteText] = useState(userNote);
          const [sequels, setSequels] = useState([]);
          const [loadingSequels, setLoadingSequels] = useState(false);
          const [generatingCover, setGeneratingCover] = useState(false);
          const [enhancingCover, setEnhancingCover] = useState(false);
          const [quote, setQuote] = useState(null);
          const [loadingQuote, setLoadingQuote] = useState(false);

          const analyzeBook = async () => {
            if (!apiKey) { setAiAnalysis("API Key fehlt."); return; }
            setAiLoading(true);
            try {
              const prompt = `Analysiere "${info.title}" von ${info.authors?.join(', ')}. 1. Zusammenfassung (max 40 Worte). 2. Drei Gr√ºnde. Deutsch.`;
              const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME_TEXT}:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
              const data = await response.json();
              setAiAnalysis(data.candidates?.[0]?.content?.parts?.[0]?.text);
            } catch (e) { setAiAnalysis("Fehler."); } finally { setAiLoading(false); }
          };

          const getBookQuote = async () => {
              if (!apiKey) { setQuote("API Key fehlt."); return; }
              setLoadingQuote(true);
              try {
                  const prompt = `Finde ein inspirierendes Zitat aus "${info.title}" von ${info.authors?.join(', ')}.`;
                  const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME_TEXT}:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                  const data = await response.json();
                  setQuote(data.candidates?.[0]?.content?.parts?.[0]?.text.replace(/"/g, ''));
              } catch (e) { setQuote("Kein Zitat gefunden."); } finally { setLoadingQuote(false); }
          };

          const getSequels = async () => {
            if (!apiKey) return;
            setLoadingSequels(true);
            try {
              const prompt = `Ist "${info.title}" von ${info.authors?.join(', ')} Teil einer Reihe? Nenne Fortsetzungen (max 5). JSON: [{"title": "...", "info": "Band 2"}]`;
              const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME_TEXT}:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } }) });
              const data = await response.json();
              setSequels(parseAIResponse(data.candidates?.[0]?.content?.parts?.[0]?.text || "[]"));
            } catch (e) { console.error(e); } finally { setLoadingSequels(false); }
          };

          const generateCover = async () => {
            if (!apiKey) return;
            setGeneratingCover(true);
            try {
              const prompt = `Buchcover Design f√ºr "${info.title}" von ${info.authors?.join(', ') || 'Unbekannt'}. Minimalistisch, √§sthetisch, hohe Qualit√§t.`;
              const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME_IMAGE}:predict?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ instances: [{ prompt: prompt }], parameters: { sampleCount: 1 } })
              });
              const data = await response.json();
              const base64 = data.predictions?.[0]?.bytesBase64Encoded;
              if (base64) {
                const compressedBase64 = await compressSmart(`data:image/png;base64,${base64}`);
                if (compressedBase64) onUpdateData({ aiCoverUrl: compressedBase64 });
              }
            } catch (err) { console.error(err); } finally { setGeneratingCover(false); }
          };

          const enhanceCover = async () => {
              if (!apiKey) { alert("API Key fehlt!"); return; }
              setEnhancingCover(true);
              try {
                  if (!book.aiCoverUrl) { alert("Nur selbst erstellte AI-Cover k√∂nnen verbessert werden."); setEnhancingCover(false); return; }
                  let base64 = book.aiCoverUrl.split(',')[1];
                  const prompt = "Make this image sharper, high resolution, highly detailed, better quality.";
                  const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME_EDIT}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64 } }] }], generationConfig: { responseModalities: ["IMAGE"] } })
                  });
                  const data = await response.json();
                  const newBase64 = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                  if (newBase64) {
                      const compressed = await compressSmart(`data:image/png;base64,${newBase64}`);
                      if (compressed) onUpdateData({ aiCoverUrl: compressed });
                  } else { alert("Fehler beim Sch√§rfen."); }
              } catch (e) { console.error(e); } finally { setEnhancingCover(false); }
          };

          const handleShare = () => { navigator.clipboard.writeText(`Ich lese gerade "${info.title}"! üìö`); alert("Kopiert!"); };
          const handleRating = (r) => { if (inLibrary) onUpdateData({ rating: r }); else alert("F√ºge das Buch erst deiner Bibliothek hinzu."); };
          const saveNote = () => { if (inLibrary) { onUpdateData({ userNote: noteText }); setEditNote(false); } else alert("F√ºge das Buch erst deiner Bibliothek hinzu."); };

          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-in fade-in">
              <div className={`rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col md:flex-row relative animate-in zoom-in-95 ${darkMode ? 'bg-slate-800 text-slate-100' : 'bg-white text-slate-800'}`}>
                <button onClick={onClose} className={`absolute top-4 right-4 p-2 rounded-full z-10 transition-colors ${darkMode ? 'bg-black/40 hover:bg-black/60 text-white' : 'bg-white/80 hover:bg-slate-100 text-slate-600'}`}><X className="w-6 h-6" /></button>
                <div className={`w-full md:w-1/3 flex items-center justify-center p-8 border-r ${darkMode ? 'bg-slate-900 border-slate-700' : 'bg-slate-100 border-slate-100'}`}>
                  <div className="shadow-2xl rounded-lg overflow-hidden max-w-[180px] w-full flex flex-col items-center group relative">
                    {thumbnail ? <img src={thumbnail} alt={info.title} className="w-full h-auto" /> : <div className="w-full aspect-[2/3] bg-slate-700 flex flex-col items-center justify-center rounded-lg p-4"><Book className="w-12 h-12 opacity-50 mb-2" /><span className="text-xs opacity-50">Kein Bild</span></div>}
                    <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-3 p-4">
                        <button onClick={generateCover} disabled={generatingCover} className="flex items-center gap-2 px-4 py-2 bg-white text-slate-900 rounded-full text-xs font-bold hover:bg-indigo-50 w-full justify-center">{generatingCover ? <Loader2 className="w-3 h-3 animate-spin" /> : <RefreshCw className="w-3 h-3" />} Neu malen</button>
                        <button onClick={enhanceCover} disabled={enhancingCover} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-full text-xs font-bold hover:bg-indigo-500 w-full justify-center">{enhancingCover ? <Loader2 className="w-3 h-3 animate-spin" /> : <Wand2 className="w-3 h-3" />} Sch√§rfen</button>
                    </div>
                  </div>
                </div>
                <div className="w-full md:w-2/3 p-6 md:p-8 overflow-y-auto">
                  <div className="flex justify-between items-start mb-2"><h2 className="text-2xl font-bold">{info.title}</h2><button onClick={handleShare} className={`p-2 rounded-full ${darkMode ? 'hover:bg-slate-700' : 'hover:bg-slate-100'}`}><Share2 className="w-5 h-5 text-indigo-500" /></button></div>
                  <div className="flex flex-wrap gap-3 mb-6">{isRead && <span className="flex items-center gap-1 bg-green-500/10 text-green-600 px-3 py-1 rounded-full text-sm font-bold border border-green-500/20"><CheckCircle className="w-4 h-4" /> Gelesen</span>}<span className={`px-3 py-1 rounded-md text-sm border ${darkMode ? 'bg-slate-700 border-slate-600' : 'bg-slate-50 border-slate-100'}`}>{info.authors?.join(', ') || 'Unbekannt'}</span><span className={`px-3 py-1 rounded-md text-sm border ${darkMode ? 'bg-slate-700 border-slate-600' : 'bg-slate-50 border-slate-100'}`}>{info.pageCount ? `${info.pageCount} Seiten` : 'N/A'}</span></div>
                  {!quote && !loadingQuote ? (<button onClick={getBookQuote} className="mb-6 flex items-center gap-2 text-xs font-bold text-indigo-500 hover:text-indigo-600"><Quote className="w-3 h-3" /> Zitat finden</button>) : (<div className={`mb-6 p-4 rounded-xl border relative italic text-center ${darkMode ? 'bg-slate-800 border-slate-700 text-slate-300' : 'bg-slate-50 border-slate-200 text-slate-600'}`}>{loadingQuote ? <Loader2 className="w-4 h-4 animate-spin mx-auto" /> : <><Quote className="w-4 h-4 absolute top-2 left-2 opacity-30" /> "{quote}"</>}</div>)}
                  {inLibrary && (<div className={`mb-6 p-4 rounded-xl border ${darkMode ? 'bg-slate-700/50 border-slate-600' : 'bg-slate-50 border-slate-200'}`}><div className="flex justify-between mb-3"><h3 className="text-xs font-bold uppercase opacity-70">Bewertung</h3><div className="flex gap-1">{[1,2,3,4,5].map(star => <button key={star} onClick={() => handleRating(star)}><Star className={`w-6 h-6 ${star <= rating ? 'text-yellow-400 fill-current' : 'text-slate-400 dark:text-slate-600'}`} /></button>)}</div></div><div><div className="flex justify-between mb-2"><h3 className="text-xs font-bold uppercase opacity-70">Notiz</h3>{!editNote && <button onClick={() => setEditNote(true)} className="text-xs flex items-center gap-1 text-indigo-500"><Edit3 className="w-3 h-3" /> Bearbeiten</button>}</div>{editNote ? <div className="flex flex-col gap-2"><textarea value={noteText} onChange={(e) => setNoteText(e.target.value)} className={`w-full p-2 rounded-lg text-sm border ${darkMode ? 'bg-slate-800 border-slate-600 text-white' : 'bg-white border-slate-300'}`} /><button onClick={saveNote} className="self-end px-3 py-1 bg-indigo-600 text-white rounded-md text-xs font-bold">Speichern</button></div> : <p className={`text-sm italic ${!userNote && 'opacity-50'}`}>{userNote || 'Keine Notizen.'}</p>}</div></div>)}
                  <div className={`mb-6 p-4 rounded-xl border ${darkMode ? 'bg-indigo-900/20 border-indigo-800' : 'bg-indigo-50 border-indigo-100'}`}><div className="flex justify-between items-center mb-2"><h3 className={`text-xs font-bold uppercase ${darkMode ? 'text-indigo-300' : 'text-indigo-800'}`}><Sparkles className="inline w-3 h-3 mr-1" /> AI Insights</h3>{!aiAnalysis && !aiLoading && <button onClick={analyzeBook} className={`text-xs px-3 py-1 rounded-full shadow-sm border font-medium ${darkMode ? 'bg-slate-700 border-slate-600' : 'bg-white border-indigo-200'}`}>Analysieren</button>}</div>{aiLoading ? <div className="text-sm opacity-70"><Loader2 className="inline w-4 h-4 animate-spin mr-2" /> ...</div> : aiAnalysis && <div className="prose prose-sm text-current opacity-90 whitespace-pre-wrap">{aiAnalysis}</div>}</div>
                  <div className={`mb-6 p-4 rounded-xl border ${darkMode ? 'bg-slate-700/30 border-slate-700' : 'bg-slate-50 border-slate-200'}`}><div className="flex justify-between items-center mb-3"><h3 className={`text-xs font-bold uppercase ${darkMode ? 'text-slate-300' : 'text-slate-700'}`}><Layers className="inline w-3 h-3 mr-1" /> Reihe</h3>{!sequels.length && !loadingSequels && <button onClick={getSequels} className={`text-xs px-3 py-1 rounded-full shadow-sm border font-medium ${darkMode ? 'bg-slate-700 border-slate-600' : 'bg-white border-slate-300'}`}>Suchen</button>}</div>{loadingSequels && <div className="text-sm opacity-70"><Loader2 className="inline w-4 h-4 animate-spin mr-2" /> ...</div>}{sequels.length > 0 && <div className="flex flex-col gap-2">{sequels.map((seq, idx) => <button key={idx} onClick={() => onSearch(seq.title)} className={`text-left p-3 rounded-lg border transition-all flex justify-between items-center group ${darkMode ? 'bg-slate-800 border-slate-600 hover:border-indigo-500' : 'bg-white border-slate-200 hover:border-indigo-500'}`}><span className="font-medium text-sm">{seq.title}</span><span className={`text-xs px-2 py-0.5 rounded-full ${darkMode ? 'bg-slate-700 text-slate-300' : 'bg-slate-100 text-slate-600'}`}>{seq.info}</span></button>)}<button onClick={() => onAddSequels(sequels)} className="mt-2 w-full flex items-center justify-center gap-2 px-4 py-2 bg-gradient-to-r from-violet-600 to-indigo-600 text-white rounded-lg font-bold text-sm hover:shadow-lg"><Layers className="w-4 h-4" /> Alle als gelesen</button></div>}</div>
                  <div className="prose prose-sm text-current opacity-80 mb-8" dangerouslySetInnerHTML={{ __html: info.description || 'Keine Beschreibung.' }} />
                  <div className={`flex gap-3 pt-6 border-t ${darkMode ? 'border-slate-700' : 'border-slate-100'}`}><button onClick={onToggleRead} className={`flex-1 flex justify-center items-center gap-2 px-4 py-3 rounded-lg font-bold border ${isRead ? 'bg-green-500/10 text-green-600 border-green-500/20' : darkMode ? 'bg-slate-700 border-slate-600 hover:border-green-500' : 'bg-white border-slate-200 hover:border-green-500'}`}><CheckCircle className="w-5 h-5" /> {isRead ? 'Gelesen' : 'Als gelesen'}</button><button onClick={onToggleLibrary} className={`flex-1 flex justify-center items-center gap-2 px-4 py-3 rounded-lg font-bold ${inLibrary ? 'bg-red-500/10 text-red-500 border border-red-500/20' : 'bg-slate-900 text-white dark:bg-indigo-600'}`}><Heart className={`w-5 h-5 ${inLibrary ? 'fill-current' : ''}`} /> {inLibrary ? 'Entfernen' : 'Merken'}</button></div>
                </div>
              </div>
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
